name: Deploy RDF Learning Resources

on:
  push:
    branches: [ master ]
    paths: [ 'rdf-learning-resources/**' ]
  pull_request:
    branches: [ master ]
    paths: [ 'rdf-learning-resources/**' ]

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "learning-resources-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create site structure
        run: |
          mkdir -p _site
          echo "Site directory created"

      - name: Download existing GitHub Pages content
        run: |
          # Try to download existing GitHub Pages content to preserve it
          echo "Attempting to preserve existing GitHub Pages content..."
          
          # Download the current site if it exists
          curl -f -s -o existing-site.tar.gz -L "https://github.com/ternaustralia/ontology_tern/archive/gh-pages.tar.gz" || echo "No existing gh-pages branch found"
          
          # If we got existing content, extract it
          if [ -f existing-site.tar.gz ]; then
            tar -xzf existing-site.tar.gz --strip-components=1 -C _site/ || echo "Failed to extract existing content"
            rm existing-site.tar.gz
            echo "‚úÖ Preserved existing GitHub Pages content"
          else
            echo "‚ÑπÔ∏è  No existing GitHub Pages content found, starting fresh"
          fi

      - name: Verify existing content preservation
        run: |
          echo "üìÅ Current site structure after preservation:"
          ls -la _site/ || echo "No content preserved"
          
          # Check if critical TERN files exist
          if [ -f "_site/index.html" ]; then
            echo "‚úÖ Found existing index.html - TERN documentation preserved"
          else
            echo "‚ö†Ô∏è  No existing index.html found - may be first deployment"
          fi

      - name: Deploy learning resources to /learning/ path (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          # Create learning directory and copy content
          mkdir -p _site/learning
          cp -r rdf-learning-resources/* _site/learning/
          
          echo "‚úÖ Learning resources deployed to /learning/"

      - name: Deploy branch preview (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Get clean branch name
          BRANCH_NAME="${{ github.head_ref }}"
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          
          # Create preview directory
          mkdir -p _site/preview/$CLEAN_BRANCH
          cp -r rdf-learning-resources/* _site/preview/$CLEAN_BRANCH/
          
          # Create preview landing page
          cat > _site/preview/$CLEAN_BRANCH/preview-info.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Preview: $BRANCH_NAME</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .preview-banner { 
                      background: #fff3cd; 
                      border: 1px solid #ffeaa7; 
                      padding: 15px; 
                      margin-bottom: 20px; 
                      border-radius: 5px;
                  }
                  .btn { 
                      background: #007cba; 
                      color: white; 
                      padding: 10px 20px; 
                      text-decoration: none; 
                      border-radius: 5px; 
                  }
              </style>
          </head>
          <body>
              <div class="preview-banner">
                  <h2>üöß Branch Preview</h2>
                  <p><strong>Branch:</strong> $BRANCH_NAME</p>
                  <p><strong>Status:</strong> Under Review</p>
                  <p>This is a preview of changes that are not yet merged to the main branch.</p>
              </div>
              
              <h1>RDF Learning Resources Preview</h1>
              <p>Click below to test the learning resources with your changes:</p>
              <a href="index.html" class="btn">Open Learning Resources</a>
              
              <hr style="margin: 40px 0;">
              <p><small>Preview URL: https://ternaustralia.github.io/ontology_tern/preview/$CLEAN_BRANCH/</small></p>
              <p><small><a href="../../">‚Üê Back to main TERN site</a></small></p>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Branch preview deployed to /preview/$CLEAN_BRANCH/"
          echo "CLEAN_BRANCH=$CLEAN_BRANCH" >> $GITHUB_ENV

      - name: Show final site structure
        run: |
          echo "üìÅ Final site structure:"
          ls -la _site/
          if [ -d "_site/preview" ]; then
            echo "üìÅ Preview directories:"
            ls -la _site/preview/
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment on PR with preview link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const cleanBranch = process.env.CLEAN_BRANCH;
            const previewUrl = `https://ternaustralia.github.io/ontology_tern/preview/${cleanBranch}/`;
            const previewInfoUrl = `https://ternaustralia.github.io/ontology_tern/preview/${cleanBranch}/preview-info.html`;
            
            const comment = `## üöÄ Preview Deployed!
            
            Your RDF Learning Resources changes are ready for review:
            
            üîó **Preview URL:** ${previewUrl}
            üìã **Preview Info:** ${previewInfoUrl}
            
            ### What to test:
            - [ ] All learning modules load correctly
            - [ ] Interactive exercises work as expected  
            - [ ] Navigation between modules functions
            - [ ] Styling and layout appear correct
            - [ ] JavaScript functionality operates properly
            
            ### Note:
            - The preview does not affect the main TERN Ontology site
            - Main site: https://ternaustralia.github.io/ontology_tern/
            - Learning resources will be at: https://ternaustralia.github.io/ontology_tern/learning/ (after merge)
            
            ### Safety Check:
            - This workflow only deploys to \`/learning/\` subdirectory (main) or \`/preview/\` (PRs)
            - Existing TERN ontology documentation is preserved
            - No conflicts with existing TERN infrastructure
            
            ‚è±Ô∏è **Note**: It may take 2-3 minutes for the preview to be available after this comment.
            
            _This preview updates automatically with each push to this branch._`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });